(function(a,b){"object"==typeof exports&&"undefined"!=typeof module?module.exports=b():"function"==typeof define&&define.amd?define(b):a.Realm=b()})(this,function(){"use strict";function a(a,b=void 0){const c=`please report internal shim error: ${a}`;console.error(c),b&&(console.error(`${b}`),console.error(`${b.stack}`));debugger;throw c}function b(b,c){b||a(c)}function c(a){return a}function d(a,b){function c(a,...b){try{return a(...b)}catch(a){if(Object(a)!==a)throw a;let b,c,d;try{b=`${a.name}`,c=`${a.message}`,d=`${a.stack}`}catch(a){throw new Error("unknown error")}const e=j.get(b)||Error;try{throw new e(c)}catch(a){throw a.stack=d,a}}}const{initRootRealm:d,initCompartment:e,getRealmGlobal:f,realmEvaluate:g}=b,{create:h,defineProperties:i}=Object,j=new Map([["EvalError",EvalError],["RangeError",RangeError],["ReferenceError",ReferenceError],["SyntaxError",SyntaxError],["TypeError",TypeError],["URIError",URIError]]);class k{constructor(){throw new TypeError("Realm is not a constructor")}static makeRootRealm(b){b=Object(b);const e=h(k.prototype);return c(d,a,e,b),e}static makeCompartment(){const b=h(k.prototype);return c(e,a,b),b}get global(){return c(f,this)}evaluate(a,b){return c(g,this,a,b)}}return i(k,{toString:{value:()=>"function Realm() { [shim code] }",writable:!1,enumerable:!1,configurable:!0}}),i(k.prototype,{toString:{value:()=>"[object Realm]",writable:!1,enumerable:!1,configurable:!0}}),k}function e(a,b){const{unsafeEval:c}=a;return c(y)(a,b)}function f(a){const c={Infinity:{value:1/0},NaN:{value:NaN},undefined:{value:void 0}};for(const d of S){const e=D(a,d);e&&(b("value"in e,`unexpected accessor on global property: ${d}`),c[d]={value:e.value,writable:!0,configurable:!0})}return c}function g(){function a(a){if(a===void 0||null===a)throw new TypeError(`can't convert undefined or null to object`);return Object(a)}function b(a){return"symbol"==typeof a?a:`${a}`}function c(a,b){if("function"!=typeof a)throw TypeError(`invalid ${b} usage`);return a}const{defineProperty:d,defineProperties:e,getOwnPropertyDescriptor:f,getPrototypeOf:g,prototype:h}=Object;try{(0,h.__lookupGetter__)("x")}catch(a){return}e(h,{__defineGetter__:{value:function(b,e){const f=a(this);d(f,b,{get:c(e,"getter"),enumerable:!0,configurable:!0})}},__defineSetter__:{value:function(b,e){const f=a(this);d(f,b,{set:c(e,"setter"),enumerable:!0,configurable:!0})}},__lookupGetter__:{value:function(c){let d=a(this);c=b(c);let e;for(;d&&!(e=f(d,c));)d=g(d);return e&&e.get}},__lookupSetter__:{value:function(c){let d=a(this);c=b(c);let e;for(;d&&!(e=f(d,c));)d=g(d);return e&&e.set}}})}function h(){function a(a,e){let f;try{f=(0,eval)(e)}catch(a){if(a instanceof SyntaxError)return;throw a}const g=c(f),h=Function("throw new TypeError(\"Not available\");");b(h,{name:{value:a}}),b(g,{constructor:{value:h}}),b(h,{prototype:{value:g}}),h!==Function.prototype.constructor&&d(h,Function.prototype.constructor)}const{defineProperties:b,getPrototypeOf:c,setPrototypeOf:d}=Object;a("Function","(function(){})"),a("GeneratorFunction","(function*(){})"),a("AsyncFunction","(async function(){})"),a("AsyncGeneratorFunction","(async function*(){})")}function i(){const a=V.runInNewContext(X);return a}function j(a,b=[]){const c=f(a);return B({unsafeGlobal:a,sharedGlobalDescs:c,unsafeEval:a.eval,unsafeFunction:a.Function,allShims:b})}function k(a){const b=Y();return b.eval(Z),b.eval($),j(b,a)}function l(a){const b=E(a),c=M(F(b),a=>{if("eval"===a||aa.has(a)||!Q(_,a))return!1;const c=b[a];return!1===c.configurable&&!1===c.writable&&L(c,"value")});return c}function m(a){const{unsafeGlobal:b,unsafeEval:c}=a;let d=!1;return{__proto__:ba,allowUnsafeEvaluatorOnce(){d=!0},unsafeEvaluatorAllowed(){return d},get(a,b){return"eval"===b?!0==d?(d=!1,c):a.eval:b===Symbol.unscopables?void 0:b in a?a[b]:void 0},set(a,b,c){if(L(a,b))throw new TypeError(`do not modify endowments like ${b+""}`);return G(a)[b]=c,!0},has(a,c){return!!("eval"===c||c in a||c in b)}}}function n(a){const b=ca.exec(a);if(b){const a=b[1].split("\n").length;throw new SyntaxError(`possible import expression rejected around line ${a}`)}}function o(a){return 0===a.length?"":`const {${O(a,",")}} = this;`}function p(a,b){const{unsafeFunction:c}=a,d=o(b);return c(`
    with (arguments[0]) {
      ${d}
      return function() {
        'use strict';
        return eval(arguments[0]);
      };
    }
  `)}function q(c,d){const{unsafeFunction:e}=c,f=m(c),g=l(d),h=p(c,g);return function(c={}){const g=A(d,E(c)),i=new Proxy(g,f),j=I(h,d,[i]),k={eval(b){b=`${b}`,n(b),f.allowUnsafeEvaluatorOnce();let c;try{return I(j,d,[b])}catch(a){throw c=a,a}finally{f.unsafeEvaluatorAllowed()&&a("handler did not revoke useUnsafeEvaluator",c)}}}.eval;return H(k,e.prototype),b(G(k).constructor!==Function,"hide Function"),b(G(k).constructor!==e,"hide unsafeFunction"),C(k,{toString:{value:k("() => 'function eval() { [shim code] }'"),writable:!1,enumerable:!1,configurable:!0}}),k}}function r(a){return a()}function s(a){return(b,c)=>a(c)(b)}function t(a,c){const{unsafeFunction:d,unsafeGlobal:e}=a,f=function(...a){const b=`${N(a)||""}`;let f=`${O(a,",")}`;if(!Q(/^[\w\s,]*$/,f))throw new e.SyntaxError("shim limitation: Function arg must be simple ASCII identifiers, possibly separated by commas: no default values, pattern matches, or non-ASCII parameter names");if(new d(b),R(f,")"))throw new e.SyntaxError("shim limitation: Function arg string contains parenthesis");0<f.length&&(f+="\n/*``*/");const g=`(function(${f}){\n${b}\n})`;return c(g)};return H(f,d.prototype),b(G(f).constructor!==Function,"hide Function"),b(G(f).constructor!==d,"hide unsafeFunction"),C(f,{prototype:{value:d.prototype},toString:{value:c("() => 'function Function() { [shim code] }'"),writable:!1,enumerable:!1,configurable:!0}}),f}function u(a){return b(Object(a)===a,"bad object, not a Realm instance"),b(da.has(a),"Realm instance has no record"),da.get(a)}function v(a,c){b(Object(a)===a,"bad object, not a Realm instance"),b(!da.has(a),"Realm instance already has a record"),da.set(a,c)}function w(a,b,c,d){C(b,a),C(b,{eval:{value:c,writable:!0,configurable:!0},Function:{value:d,writable:!0,configurable:!0}})}function x(a){const{sharedGlobalDescs:b,unsafeGlobal:c}=a,d=A(c.Object.prototype),e=q(a,d),f=r(e),g=s(e),h=t(a,f);w(b,d,f,h);const i=B({safeGlobal:d,safeEval:f,safeEvalWhichTakesEndowments:g,safeFunction:h});return i}const y=c(`'use strict'; (${d})`),{assign:z,create:A,freeze:B,defineProperties:C,getOwnPropertyDescriptor:D,getOwnPropertyDescriptors:E,getOwnPropertyNames:F,getPrototypeOf:G,setPrototypeOf:H}=Object,{apply:I,ownKeys:J}=Reflect,K=a=>(b,...c)=>I(a,b,c),L=K(Object.prototype.hasOwnProperty),M=K(Array.prototype.filter),N=K(Array.prototype.pop),O=K(Array.prototype.join),P=K(Array.prototype.concat),Q=K(RegExp.prototype.test),R=K(String.prototype.includes),S=["isFinite","isNaN","parseFloat","parseInt","decodeURI","decodeURIComponent","encodeURI","encodeURIComponent","Array","ArrayBuffer","Boolean","DataView","Date","Error","EvalError","Float32Array","Float64Array","Int8Array","Int16Array","Int32Array","Map","Number","Object","Promise","Proxy","RangeError","ReferenceError","RegExp","Set","String","Symbol","SyntaxError","TypeError","Uint8Array","Uint8ClampedArray","Uint16Array","Uint32Array","URIError","WeakMap","WeakSet","JSON","Math","Reflect","escape","unescape","Intl"],T="object"==typeof exports&&"undefined"!=typeof module,U="object"==typeof document;if(!T&&!U)throw new Error("unexpected platform, unable to create Realm");let V;T&&!U&&(V=require("vm"));const W="'use strict'; this",X=`(0, eval)("'use strict'; this")`;let Y=function(){const a=document.createElement("iframe");a.style.display="none",document.body.appendChild(a);const b=a.contentWindow.eval(W);return b};T&&!U&&(Y=i);const Z=c(`"use strict"; (${g})();`),$=c(`"use strict"; (${h})();`),_=/^[a-zA-Z_$][\w$]*$/,aa=new Set(["await","break","case","catch","class","const","continue","debugger","default","delete","do","else","export","extends","finally","for","function","if","import","in","instanceof","new","return","super","switch","this","throw","try","typeof","var","void","while","with","yield","let","static","enum","implements","package","protected","interface","private","public","await","null","true","false","this","arguments"]),ba=new Proxy(B({}),{get(b,c){a(`unexpected scope handler trap called: ${c}`)}}),ca=/^(.*)\bimport\s*(\(|\/\/|\/\*)/m,da=new WeakMap,ea={initRootRealm:function(a,b,c){const{shims:d}=c,f=P(a.allShims,d),g=k(f),h=e(g,ea);g.sharedGlobalDescs.Realm={value:h,writable:!0,configurable:!0};const i=x(g),{safeEvalWhichTakesEndowments:j}=i;for(const d of f)j(d);v(b,i)},initCompartment:function(a,b){const c=x(a);v(b,c)},getRealmGlobal:function(a){const{safeGlobal:b}=u(a);return b},realmEvaluate:function(a,b,c={}){const{safeEvalWhichTakesEndowments:d}=u(a);return d(b,c)}},fa=function(){const a=(0,eval)(W);return g(),h(),j(a)}(),ga=d(fa,ea);return ga});
//# sourceMappingURL=realm-shim.min.js.map
